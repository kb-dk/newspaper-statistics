<!DOCTYPE html>
<html>
<head>
  <title>Batch Statistics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Newspaper batch statistics">
  <meta name="author" content="The State and University Library, Denmark">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

  <!-- Styles -->
  <link rel="stylesheet" type="text/css" href="xmltree/xmltree.css">
  <link rel="stylesheet" type="text/css" href="jquery/ui/1.10.4/themes/smoothness/jquery-ui.css">
  <style type="text/css">
    .dp-highlight .ui-state-default {
      background: #484;
      color: #FFF;
    }
  </style>
</head>

<body>

<div id="container">
  <div id='xmltree' style="float:left;width:400px;">
    <div><h1>Batch statistik</h1></div>
    <b>Filter</b>
    <input type="text" id="search_input" tabindex="-1" ></div>
  <div style="float:right;margin-right:10px;">
    <div><h1>Udgave kalender</h1></div>
    <div id="calendar-container"></div>
    <div id="fuzzydates"><h3>Delvise datoer</h3></div>
  </div>
</div>

<script src="jquery/jquery-2.0.3.min.js"></script>
<script src="jquery/ui/1.10.4/jquery-ui.js"></script>
<script src="jquery/ui/1.10.4/i18n/datepicker-da.js"></script>
<script src="xmltree/xmltree.js"></script>
<script src="jquery/jquey.highlight.js"></script>
<script src="calendarview.js"></script>

<script>
  var batchid = location.search.split('batchid=')[1]
  var filepath = "data/" + batchid + '/count-statistics.xml'
  $(function() { new XMLTree({
    fpath: filepath, container: '#xmltree', startExpanded: false, openAtPath: 'Batch' , attrs: 'hidden'
  }); });

  $(document).ready(function() {
    jQuery.expr[':'].Contains = function(a,i,m){
      return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
    };

    var container = $('body');

    $('#search_input').focus().keyup(function(e){
      var filter = $(this).val();
      filterTree(filter);
    });

    $('#search_input').focus().keydown(function(e){
      $('#xmltree').unhighlight();
    });
  });

  function filterTree(filter) {
    if (filter) {
      $('#xmltree').find("li:not(:Contains(" + filter + "))").parent().hide();
      $('#xmltree').find("li:Contains(" + filter + ")").parent().show();
      $("#xmltree").find("li:Contains(" + filter + ")").children().show();
      $('#xmltree').highlight(filter);
    }
  }
</script>

<script>
  var batchid = location.search.split('batchid=')[1]
  var datefilepath = "data/" + batchid + '/date-statistics.xml'

  $(document).ready(function() {
    var films;
    var partialDates = [];
    var startdate;
    var lastdate;
    $.ajax({
      type: "GET",
      url: datefilepath,
      dataType: "xml",
      success: function(xml) {
        films = []
        fuzzyDates = []
        $(xml).find('Film').each(function() {
          var filmname = $(this).attr('name');
          films[filmname] = []
          $(this).find('Edition-dates').each(function() {
            $(this).children().each(function() {
              date = $(this).prop("tagName").replace('E','');
              if (date.match(/-/g).length === 2) {
                films[filmname].push(date);
                if (date < startdate || startdate == undefined) startdate = date;
                if (date > lastdate || lastdate == undefined) lastdate = date;
              } else {
                partialDates.push(date)
              }
            });
          });
        });
        minDate = new Date (startdate);
        maxDate = new Date (lastdate);
        initCalendar(films, minDate,  maxDate);
        initPartialDates({dates: partialDates});
      }
    });

  });

  function initCalendar(films, minDate,  maxDate) {
    $("#calendar-container").datepicker({
      numberOfMonths: [3,2],
      changeMonth: true,
      changeYear: true,
      setDate: minDate,
      minDate: minDate,
      maxDate: maxDate,
      dateFormat: 'yy-mm-dd', onSelect: function() {
        date = $(this).datepicker('getDate');
        filterTree($.datepicker.formatDate('yy-mm-dd', date));
      },
      beforeShowDay: function(date) {
        var r = [true, "", ''];
        if (films  == undefined) {} else {
          var search = $.datepicker.formatDate('yy-mm-dd', date);
          for (var film in films) {
            if ($.inArray(search, films[film]) > -1) {
              r[1] = "dp-highlight";
              r[2] = film;
              break;
            }
          }
        }
        return r;
      }
    });
  }

  function initPartialDates(parameters) {
    var editiondates = parameters.dates;
    $("#fuzzydates").append(editiondates.toString());
  }
</script>

</body>
</html>